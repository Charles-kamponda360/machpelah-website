<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Machpelah Electronics</title>
    <link rel="stylesheet" href="../css/admin.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1"></script>
    
    <style>
        .form-control {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            color: #1a1a1a;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .stat-icon img, .tab-icon img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .stat-card .stat-icon img {
            width: 40px;
            height: 40px;
        }

        .messages-badge {
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            margin-left: 0.5rem;
            font-weight: bold;
        }

        .hamburger {
            display: none;
            flex-direction: column;
            gap: 4px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            z-index: 1001;
        }
        
        .hamburger span {
            width: 25px;
            height: 3px;
            background: #FFD700;
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem !important;
            }

            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap !important;
            }

            .tab {
                white-space: nowrap;
                min-width: fit-content;
            }
        }

        @media (max-width: 768px) {
            .hamburger {
                display: flex !important;
            }

            .admin-header .header-content {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .admin-header .logo-section {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .tabs-container .tabs {
                position: fixed !important;
                top: 70px !important;
                left: 0 !important;
                right: 0 !important;
                background: #1f2937 !important;
                flex-direction: column !important;
                width: 100% !important;
                max-height: 0 !important;
                overflow: hidden !important;
                transition: max-height 0.3s ease !important;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
                z-index: 999 !important;
                padding: 0 !important;
            }
            
            .tabs-container .tabs.active {
                max-height: 500px !important;
                padding: 1rem 0 !important;
            }

            .tab {
                width: 100% !important;
                text-align: left !important;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
                justify-content: flex-start !important;
                padding: 1rem 1.5rem !important;
            }

            .tab:last-child {
                border-bottom: none !important;
            }

            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            .form-row {
                flex-direction: column !important;
            }

            .table-container {
                overflow-x: auto;
            }

            .products-table {
                font-size: 0.85rem;
            }

            .products-table th,
            .products-table td {
                padding: 0.5rem !important;
            }

            #daily-chart {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @media (max-width: 480px) {
            .admin-header h1 {
                font-size: 1.2rem;
            }

            .btn {
                font-size: 0.85rem;
                padding: 0.6rem 1rem;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .stat-label {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="header-content">
            <div class="logo-section">
                <img src="../images/icons/Logoicon.png" alt="Logo" class="logo" onerror="this.style.display='none'">
                <div class="brand-title">Machpelah Admin</div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="hamburger" id="hamburger" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                
                <a href="login.html" class="logout-btn">Logout</a>
            </div>
        </div>
    </div>

    <div class="admin-container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <img src="../images/icons/product_icon.png" alt="Products" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23667eea%22><text y=%2220%22 font-size=%2220%22>üì¶</text></svg>'">
                </div>
                <div class="stat-value" id="total-products">0</div>
                <div class="stat-label">Total Products</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <img src="../images/icons/instock_icon.png" alt="In Stock" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%2310b981%22><text y=%2220%22 font-size=%2220%22>‚úÖ</text></svg>'">
                </div>
                <div class="stat-value" id="in-stock">0</div>
                <div class="stat-label">In Stock</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <img src="../images/icons/stock alert icon.png" alt="Low Stock" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23f59e0b%22><text y=%2220%22 font-size=%2220%22>‚ö†Ô∏è</text></svg>'">
                </div>
                <div class="stat-value" id="low-stock">0</div>
                <div class="stat-label">Low Stock</div>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tabs" id="tabs-menu">
                <button class="tab active" data-tab="announcements">
                    <span class="tab-icon">
                        <img src="../images/icons/announcement icon.png" alt="Announcements" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2218%22>üì¢</text></svg>'">
                    </span>
                    Announcements
                </button>
                <button class="tab" data-tab="products">
                    <span class="tab-icon">
                        <img src="../images/icons/product icon.png" alt="Products" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2218%22>üì¶</text></svg>'">
                    </span>
                    Products
                </button>
                <button class="tab" data-tab="add-product">
                    <span class="tab-icon">
                        <img src="../images/icons/add product icon.png" alt="Add Product" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2218%22>‚ûï</text></svg>'">
                    </span>
                    Add Product
                </button>
                <button class="tab" id="messages-tab">
                    <span class="tab-icon">
                        <img src="../images/icons/message_icon.png" alt="Messages" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2218%22>üìß</text></svg>'">
                    </span>
                    Messages
                    <span class="messages-badge" id="unread-count" style="display: none;">0</span>
                </button>
                <button class="tab" data-tab="analytics">
                    <span class="tab-icon">
                        <img src="../images/icons/analytics_icon.png" alt="Analytics" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2218%22>üìä</text></svg>'">
                    </span>
                    Analytics
                </button>
            </div>
        </div>

        <div id="announcements" class="tab-content active">
            <div class="admin-section">
                <h2>Manage Announcements</h2>
                <div id="announcement-alert"></div>
                
                <div class="form-group">
                    <label for="announcement-text">Announcement Message</label>
                    <textarea id="announcement-text" placeholder="Enter announcement text (e.g., 20% OFF on all Smart Watches this week!)"></textarea>
                </div>

                <div class="form-group">
                    <label>Announcement Type</label>
                    <div style="display: flex; gap: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="announcement-type" value="positive" checked>
                            <img src="../images/icons/good news icon.png" alt="Positive" style="width: 24px; height: 24px;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2220%22>‚úÖ</text></svg>'">
                            <span style="color: #10b981; font-weight: 600;">Positive (Green)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="announcement-type" value="negative">
                            <img src="../images/icons/bad news icon.png" alt="Negative" style="width: 24px; height: 24px;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2220%22>‚ö†Ô∏è</text></svg>'">
                            <span style="color: #ef4444; font-weight: 600;">Negative (Red)</span>
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" id="update-announcement-btn">Update Announcement</button>
                    <button class="btn btn-danger" id="clear-announcement-btn">Clear Announcement</button>
                </div>

                <div class="alert alert-info" style="margin-top: 1.5rem;">
                    <strong>Current Announcement:</strong><br>
                    <div id="current-announcement-preview" style="margin-top: 0.5rem;">None</div>
                </div>
            </div>
        </div>

        <div id="products" class="tab-content">
            <div class="admin-section">
                <h2>Manage Products</h2>
                <div id="products-alert"></div>
                
                <div class="table-container">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price (MWK)</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-list">
                            <tr><td colspan="6" style="text-align: center; padding: 2rem;">Loading products...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="add-product" class="tab-content">
            <div class="admin-section">
                <h2>Add New Product</h2>
                <div id="add-product-alert"></div>
                
                <form id="add-product-form">
                    <div class="form-group">
                        <label for="product-name">Product Name *</label>
                        <input type="text" id="product-name" placeholder="e.g., Smart Watch X1" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-category">Category *</label>
                            <select id="product-category" required>
                                <option value="">Select Category</option>
                                <option value="PC">PC</option>
                                <option value="Smart Watch">Smart Watch</option>
                                <option value="Kettle">Kettle</option>
                                <option value="Hotplate">Hotplate</option>
                                <option value="Rice Cooker">Rice Cooker</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="product-price">Price (MWK) *</label>
                            <input type="number" id="product-price" placeholder="50000" min="0" required>
                        </div>

                        <div class="form-group">
                            <label for="product-stock">Stock Quantity *</label>
                            <input type="number" id="product-stock" placeholder="10" min="0" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="product-image">Image URL *</label>
                        <input type="url" id="product-image" placeholder="https://example.com/image.jpg" required>
                    </div>

                    <div class="form-group">
                        <label for="product-description">Description</label>
                        <textarea id="product-description" placeholder="Enter product description"></textarea>
                    </div>

                    <button type="submit" class="btn btn-success">Add Product</button>
                </form>
            </div>
        </div>

        <div id="analytics" class="tab-content">
            <div class="admin-section">
                <h2>Website Analytics</h2>
                
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <img src="../images/icons/total_viewers_icon.png" alt="Views" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2220%22>üëÅÔ∏è</text></svg>'">
                        </div>
                        <div class="stat-value" id="total-views">0</div>
                        <div class="stat-label">Total Views</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <img src="../images/icons/today_views_icon.png" alt="Today" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2220%22>üìÖ</text></svg>'">
                        </div>
                        <div class="stat-value" id="today-views">0</div>
                        <div class="stat-label">Today's Views</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <img src="../images/icons/time_icon.png" alt="Time" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2220%22>‚è±Ô∏è</text></svg>'">
                        </div>
                        <div class="stat-value" id="avg-time">0s</div>
                        <div class="stat-label">Avg. Time on Page</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">
                            <img src="../images/icons/vistors_data_icon.png" alt="Visitors" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2220%22 font-size=%2220%22>üë•</text></svg>'">
                        </div>
                        <div class="stat-value" id="unique-visitors">0</div>
                        <div class="stat-label">Unique Visitors (7d)</div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" id="refresh-analytics">
                        <img src="../images/icons/refresh_data_icon.png" alt="Refresh" style="width: 40px; height: 40px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;" onerror="this.style.display='none'">
                        Refresh Data
                    </button>
                    <select id="time-filter" class="form-control" style="width: auto;">
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                </div>

                <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 1rem; color: #1a1a1a;">
                        <img src="../images/icons/daily_views_icon.png" alt="Chart" style="width: 60px; height: 60px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;" onerror="this.style.display='none'">
                        Daily Views
                    </h3>
                    <div id="daily-chart" style="height: 300px; display: flex; align-items: flex-end; gap: 0.5rem; overflow-x: auto; padding: 1rem;">
                        <p style="color: #666;">Loading chart...</p>
                    </div>
                </div>

                <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 1rem; color: #1a1a1a;">
                        <img src="../images/icons/vistors_icon.png" alt="Visitors" style="width: 60px; height: 60px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;" onerror="this.style.display='none'">
                        Recent Visitors
                    </h3>
                    <div class="table-container">
                        <table class="products-table">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Page</th>
                                    <th>Referrer</th>
                                    <th>Device</th>
                                    <th>Screen</th>
                                    <th>Time Spent</th>
                                </tr>
                            </thead>
                            <tbody id="visitors-list">
                                <tr><td colspan="6" style="text-align: center; padding: 2rem;">Loading visitors...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-top: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 1rem; color: #1a1a1a;">
                        <img src="../images/icons/fire_icon.png" alt="Top" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;" onerror="this.style.display='none'">
                        Top Pages
                    </h3>
                    <div id="top-pages-list">
                        <p style="color: #666;">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const SUPABASE_URL = 'https://ycpaoqlcqziszlkbmtys.supabase.co';
            const SUPABASE_ANON_KEY = 'sb_publishable_pY3O8k5g8yki-zGXAMdlXQ_ugRNoL60';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const hamburger = document.getElementById('hamburger');
            const tabsMenu = document.getElementById('tabs-menu');
            
            hamburger.addEventListener('click', function() {
                this.classList.toggle('active');
                tabsMenu.classList.toggle('active');
            });

            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    hamburger.classList.remove('active');
                    tabsMenu.classList.remove('active');
                });
            });

            document.addEventListener('click', function(e) {
                if (!hamburger.contains(e.target) && !tabsMenu.contains(e.target)) {
                    hamburger.classList.remove('active');
                    tabsMenu.classList.remove('active');
                }
            });

            document.getElementById('messages-tab').addEventListener('click', function() {
                window.location.href = 'messages.html';
            });

            async function loadUnreadCount() {
                try {
                    const { data, error } = await supabase.from('contact_messages').select('id', { count: 'exact' }).eq('status', 'unread');
                    if (error) throw error;
                    const count = data?.length || 0;
                    const badge = document.getElementById('unread-count');
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error loading unread count:', error);
                }
            }

            const ProductsDB = {
                async getAll() {
                    try {
                        const { data, error } = await supabase.from('products').select('*').order('id', { ascending: false });
                        if (error) throw error;
                        return data || [];
                    } catch (error) {
                        console.error('Error:', error);
                        return [];
                    }
                },
                async add(product) {
                    try {
                        const { data, error } = await supabase.from('products').insert([product]).select();
                        if (error) throw error;
                        return { success: true, data: data[0] };
                    } catch (error) {
                        return { success: false, error: error.message };
                    }
                },
                async update(id, updates) {
                    try {
                        const { data, error } = await supabase.from('products').update(updates).eq('id', id).select();
                        if (error) throw error;
                        return { success: true, data: data[0] };
                    } catch (error) {
                        return { success: false, error: error.message };
                    }
                },
                async delete(id) {
                    try {
                        const { error } = await supabase.from('products').delete().eq('id', id);
                        if (error) throw error;
                        return { success: true };
                    } catch (error) {
                        return { success: false, error: error.message };
                    }
                }
            };

            const AnnouncementsDB = {
                async get() {
                    try {
                        const { data, error } = await supabase.from('announcements').select('*').order('created_at', { ascending: false }).limit(1).single();
                        if (error && error.code !== 'PGRST116') throw error;
                        return data || null;
                    } catch (error) {
                        return null;
                    }
                },
                async set(text, type) {
                    try {
                        const { data: existing } = await supabase.from('announcements').select('id').limit(1).single();
                        if (existing) {
                            const { data, error } = await supabase.from('announcements').update({ text, type, updated_at: new Date().toISOString() }).eq('id', existing.id).select();
                            if (error) throw error;
                            return { success: true, data: data[0] };
                        } else {
                            const { data, error } = await supabase.from('announcements').insert([{ text, type }]).select();
                            if (error) throw error;
                            return { success: true, data: data[0] };
                        }
                    } catch (error) {
                        return { success: false, error: error.message };
                    }
                },
                async clear() {
                    try {
                        const { error } = await supabase.from('announcements').delete().neq('id', 0);
                        if (error) throw error;
                        return { success: true };
                    } catch (error) {
                        return { success: false, error: error.message };
                    }
                }
            };

            const AnalyticsDB = {
                async getTotalViews() {
                    try {
                        const { data, error } = await supabase.from('site_stats').select('total_views').eq('id', 1).single();
                        if (error && error.code !== 'PGRST116') throw error;
                        return data?.total_views || 0;
                    } catch (error) {
                        return 0;
                    }
                },
                async getPageViews(daysLimit = null) {
                    try {
                        let query = supabase.from('page_views').select('*').order('timestamp', { ascending: false });
                        if (daysLimit) {
                            const cutoffDate = new Date();
                            cutoffDate.setDate(cutoffDate.getDate() - daysLimit);
                            query = query.gte('timestamp', cutoffDate.toISOString());
                        }
                        const { data, error } = await query.limit(100);
                        if (error) throw error;
                        return data || [];
                    } catch (error) {
                        return [];
                    }
                },
                async getDailyStats(days = 7) {
                    try {
                        const cutoffDate = new Date();
                        cutoffDate.setDate(cutoffDate.getDate() - days);
                        const { data, error } = await supabase.from('page_views').select('timestamp').gte('timestamp', cutoffDate.toISOString()).order('timestamp', { ascending: true });
                        if (error) throw error;
                        const dailyStats = {};
                        (data || []).forEach(view => {
                            const date = new Date(view.timestamp).toLocaleDateString();
                            dailyStats[date] = (dailyStats[date] || 0) + 1;
                        });
                        return dailyStats;
                    } catch (error) {
                        return {};
                    }
                },
                async getTopPages(days = 7) {
                    try {
                        const cutoffDate = new Date();
                        cutoffDate.setDate(cutoffDate.getDate() - days);
                        const { data, error } = await supabase.from('page_views').select('page_url, page_title').gte('timestamp', cutoffDate.toISOString());
                        if (error) throw error;
                        const pageCounts = {};
                        (data || []).forEach(view => {
                            const url = view.page_url || 'Unknown';
                            const title = view.page_title || 'Unknown Page';
                            const key = `${title}|${url}`;
                            pageCounts[key] = (pageCounts[key] || 0) + 1;
                        });
                        return Object.entries(pageCounts).map(([key, count]) => {
                            const [title, url] = key.split('|');
                            return { title, url, count };
                        }).sort((a, b) => b.count - a.count).slice(0, 10);
                    } catch (error) {
                        return [];
                    }
                }
            };

            async function loadAnalytics() {
                const days = parseInt(document.getElementById('time-filter').value);
                const totalViews = await AnalyticsDB.getTotalViews();
                document.getElementById('total-views').textContent = totalViews.toLocaleString();
                const pageViews = await AnalyticsDB.getPageViews(days);
                const today = new Date().toDateString();
                const todayViews = pageViews.filter(v => new Date(v.timestamp).toDateString() === today).length;
                document.getElementById('today-views').textContent = todayViews;
                const validTimes = pageViews.filter(v => v.time_spent_seconds && v.time_spent_seconds > 0).map(v => v.time_spent_seconds);
                const avgTime = validTimes.length > 0 ? Math.round(validTimes.reduce((a, b) => a + b, 0) / validTimes.length) : 0;
                document.getElementById('avg-time').textContent = avgTime + 's';
                const uniqueAgents = new Set(pageViews.filter(v => {
                    const viewDate = new Date(v.timestamp);
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return viewDate >= weekAgo;
                }).map(v => v.user_agent));
                document.getElementById('unique-visitors').textContent = uniqueAgents.size;
                await loadDailyChart(days);
                loadVisitorsTable(pageViews);
                loadTopPages(days);
            }

            async function loadDailyChart(days) {
                const dailyStats = await AnalyticsDB.getDailyStats(days);
                const chartContainer = document.getElementById('daily-chart');
                if (Object.keys(dailyStats).length === 0) {
                    chartContainer.innerHTML = '<p style="color: #666;">No data available</p>';
                    return;
                }
                const maxViews = Math.max(...Object.values(dailyStats));
                chartContainer.innerHTML = Object.entries(dailyStats).map(([date, views]) => {
                    const height = maxViews > 0 ? (views / maxViews) * 100 : 0;
                    return `<div style="flex: 1; min-width: 60px; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;"><div style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px 4px 0 0; height: ${height}%; min-height: 20px; display: flex; align-items: flex-start; justify-content: center; padding-top: 0.25rem; color: white; font-size: 0.75rem; font-weight: bold;">${views}</div><div style="font-size: 0.7rem; color: #666; text-align: center; transform: rotate(-45deg); white-space: nowrap;">${date.split('/').slice(0, 2).join('/')}</div></div>`;
                }).join('');
            }

            function loadVisitorsTable(pageViews) {
                const tbody = document.getElementById('visitors-list');
                if (pageViews.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No visitors yet</td></tr>';
                    return;
                }
                tbody.innerHTML = pageViews.slice(0, 50).map(view => {
                    const date = new Date(view.timestamp);
                    const pageUrl = view.page_url ? new URL(view.page_url) : null;
                    const pageName = pageUrl && (pageUrl.pathname === '/' || pageUrl.pathname === '/index.html') ? 'Home' : (pageUrl ? pageUrl.pathname.split('/').pop().replace('.html', '') : 'Unknown');
                    const deviceInfo = parseUserAgent(view.user_agent);
                    const timeSpent = view.time_spent_seconds ? `${view.time_spent_seconds}s` : '-';
                    return `<tr><td style="white-space: nowrap;">${date.toLocaleDateString()}<br><small style="color: #666;">${date.toLocaleTimeString()}</small></td><td><strong>${view.page_title || pageName}</strong></td><td>${view.referrer || 'Direct'}</td><td>${deviceInfo}</td><td>${view.screen_resolution || '-'}</td><td>${timeSpent}</td></tr>`;
                }).join('');
            }

            async function loadTopPages(days) {
                const topPages = await AnalyticsDB.getTopPages(days);
                const container = document.getElementById('top-pages-list');
                if (topPages.length === 0) {
                    container.innerHTML = '<p style="color: #666;">No data available</p>';
                    return;
                }
                container.innerHTML = topPages.map((page, index) => `<div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: ${index % 2 === 0 ? '#f9fafb' : 'white'}; border-radius: 6px; margin-bottom: 0.5rem;"><div style="font-size: 1.5rem; font-weight: bold; color: ${index < 3 ? '#FFD700' : '#999'}; min-width: 30px;">${index + 1}</div><div style="flex: 1;"><div style="font-weight: 600; color: #1a1a1a;">${page.title}</div><div style="font-size: 0.85rem; color: #666;">${page.url}</div></div><div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold;">${page.count} views</div></div>`).join('');
            }

            function parseUserAgent(userAgent) {
                if (!userAgent) return 'Unknown';
                if (userAgent.includes('Mobile') || userAgent.includes('Android')) return 'Mobile';
                if (userAgent.includes('Tablet') || userAgent.includes('iPad')) return 'Tablet';
                return 'Desktop';
            }

            async function loadCurrentAnnouncement() {
                const announcement = await AnnouncementsDB.get();
                if (announcement) {
                    displayAnnouncementPreview(announcement.text, announcement.type);
                    document.getElementById('announcement-text').value = announcement.text;
                    document.querySelector(`input[name="announcement-type"][value="${announcement.type}"]`).checked = true;
                } else {
                    document.getElementById('current-announcement-preview').textContent = 'No announcement set';
                }
            }

            async function updateAnnouncement() {
                const text = document.getElementById('announcement-text').value.trim();
                const type = document.querySelector('input[name="announcement-type"]:checked').value;
                if (!text) {
                    showAlert('announcement-alert', 'Please enter message', 'info');
                    return;
                }
                const result = await AnnouncementsDB.set(text, type);
                if (result.success) {
                    displayAnnouncementPreview(text, type);
                    showAlert('announcement-alert', 'Updated successfully!', 'success');
                } else {
                    showAlert('announcement-alert', 'Error: ' + result.error, 'info');
                }
            }

            async function clearAnnouncement() {
                const result = await AnnouncementsDB.clear();
                if (result.success) {
                    document.getElementById('announcement-text').value = '';
                    document.getElementById('current-announcement-preview').textContent = 'No announcement set';
                    document.querySelector('input[name="announcement-type"][value="positive"]').checked = true;
                    showAlert('announcement-alert', 'Cleared successfully!', 'success');
                } else {
                    showAlert('announcement-alert', 'Error occurred', 'info');
                }
            }

            function displayAnnouncementPreview(text, type) {
                const color = type === 'positive' ? '#10b981' : '#ef4444';
                const bgColor = type === 'positive' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                const iconSrc = type === 'positive' ? '../images/icons/good news icon.png' : '../images/icons/bad news icon.png';
                document.getElementById('current-announcement-preview').innerHTML = `<div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: ${bgColor}; border-left: 4px solid ${color}; border-radius: 6px;"><img src="${iconSrc}" alt="${type}" style="width: 24px; height: 24px;" onerror="this.textContent='${type === 'positive' ? '‚úÖ' : '‚ö†Ô∏è'}'"><span style="flex: 1; color: #1a1a1a;">${text}</span></div>`;
            }

            async function loadProducts() {
                const products = await ProductsDB.getAll();
                const tbody = document.getElementById('products-list');
                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No products yet</td></tr>';
                } else {
                    tbody.innerHTML = products.map(p => `<tr><td><img src="${p.image}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/50'" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;"></td><td><strong>${p.name}</strong></td><td>${p.category}</td><td><strong>${p.price.toLocaleString()}</strong></td><td>${p.stock}</td><td><button class="btn btn-warning" onclick="window.editProduct(${p.id})">Edit</button> <button class="btn btn-danger" onclick="window.deleteProduct(${p.id})">Delete</button></td></tr>`).join('');
                }
                updateStatistics(products);
            }

            function updateStatistics(products) {
                document.getElementById('total-products').textContent = products.length;
                document.getElementById('in-stock').textContent = products.filter(p => p.stock > 0).length;
                document.getElementById('low-stock').textContent = products.filter(p => p.stock > 0 && p.stock < 10).length;
            }

            async function addProduct(event) {
                event.preventDefault();
                const newProduct = {
                    name: document.getElementById('product-name').value,
                    category: document.getElementById('product-category').value,
                    price: parseInt(document.getElementById('product-price').value),
                    stock: parseInt(document.getElementById('product-stock').value),
                    image: document.getElementById('product-image').value,
                    description: document.getElementById('product-description').value
                };
                const result = await ProductsDB.add(newProduct);
                if (result.success) {
                    showAlert('add-product-alert', 'Product added successfully!', 'success');
                    document.getElementById('add-product-form').reset();
                    await loadProducts();
                } else {
                    showAlert('add-product-alert', 'Error: ' + result.error, 'info');
                }
            }

            window.editProduct = async function(id) {
                const products = await ProductsDB.getAll();
                const product = products.find(p => p.id === id);
                if (!product) return;
                const newPrice = prompt('Enter new price:', product.price);
                const newStock = prompt('Enter new stock:', product.stock);
                const updates = {};
                if (newPrice !== null && newPrice !== '') updates.price = parseInt(newPrice);
                if (newStock !== null && newStock !== '') updates.stock = parseInt(newStock);
                if (Object.keys(updates).length > 0) {
                    const result = await ProductsDB.update(id, updates);
                    if (result.success) {
                        await loadProducts();
                        showAlert('products-alert', 'Product updated successfully!', 'success');
                    } else {
                        showAlert('products-alert', 'Error occurred', 'info');
                    }
                }
            };

            window.deleteProduct = async function(id) {
                if (!confirm('Are you sure?')) return;
                const result = await ProductsDB.delete(id);
                if (result.success) {
                    await loadProducts();
                    showAlert('products-alert', 'Product deleted successfully!', 'success');
                } else {
                    showAlert('products-alert', 'Error occurred', 'info');
                }
            };

            function showAlert(elementId, message, type) {
                const alertDiv = document.getElementById(elementId);
                alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => { alertDiv.innerHTML = ''; }, 4000);
            }

            document.querySelector('.tabs').addEventListener('click', function(e) {
                const tabButton = e.target.closest('.tab');
                if (!tabButton) return;
                const tabName = tabButton.getAttribute('data-tab');
                if (!tabName) return;
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
                tabButton.classList.add('active');
                if (tabName === 'analytics') setTimeout(loadAnalytics, 100);
            });

            document.getElementById('update-announcement-btn').addEventListener('click', updateAnnouncement);
            document.getElementById('clear-announcement-btn').addEventListener('click', clearAnnouncement);
            document.getElementById('add-product-form').addEventListener('submit', addProduct);
            document.getElementById('refresh-analytics').addEventListener('click', loadAnalytics);
            document.getElementById('time-filter').addEventListener('change', loadAnalytics);

            loadCurrentAnnouncement();
            loadProducts();
            loadUnreadCount();
            setInterval(loadUnreadCount, 30000);
        });
    </script>
</body>
</html>