<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Announcements - Machpelah Electronics</title>
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1"></script>
</head>
<body>
    <!-- Announcement Banner -->
    <div id="announcement-banner" class="announcement-banner"></div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <img src="images/icons/Machpelahtshirt.png" alt="Machpelah Electronics Logo" onerror="this.src='https://via.placeholder.com/50x50/667eea/ffffff?text=ME'">
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="announcements.html" class="active">Announcements</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="cart.html" class="cart-link">
                    Cart <span id="cart-count" class="cart-badge">0</span>
                </a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="hero">
        <div class="container">
            <h2>üì¢ Latest Announcements & Updates</h2>
            <p>Stay informed with our latest promotions, price changes, and important news</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <section class="announcements-section">
            <!-- Loading State -->
            <div id="loading-state" style="text-align: center; padding: 3rem;">
                <p style="font-size: 1.2rem; color: #667eea;">Loading announcements...</p>
            </div>

            <!-- Announcements List -->
            <div id="announcements-list"></div>

            <!-- Subscription Box -->
            <div class="subscription-box">
                <h3>üì¨ Subscribe for Instant Updates</h3>
                <p>Never miss a promotion! Get notifications via WhatsApp or Email</p>
                <form class="subscription-form" id="subscription-form">
                    <input type="text" id="sub-name" required placeholder="Your Name">
                    <input type="email" id="sub-email" placeholder="Email (optional)">
                    <input type="tel" id="sub-whatsapp" placeholder="WhatsApp (optional)">
                    <button type="submit" class="subscribe-btn">Subscribe</button>
                </form>
                <div class="success-message" id="sub-success">
                    ‚úì Successfully subscribed! You'll receive updates soon.
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Machpelah Electronics</h3>
                    <p>Your trusted source for quality home appliances</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="announcements.html">Announcements</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="admin/index.html">Admin</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <p>Email: machpelah@gmail.com</p>
                    <p>WhatsApp: +265 991765645</p>
                </div>
            </div>
            <p class="footer-bottom">&copy; 2025 Machpelah Electronics. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/products.js"></script>
    <script src="js/cart.js"></script>
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://ycpaoqlcqziszlkbmtys.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_pY3O8k5g8yki-zGXAMdlXQ_ugRNoL60';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let storedAnnouncements = [];

        // Fetch announcements from Supabase
        async function loadAnnouncementsFromDB() {
            try {
                console.log('Fetching announcements from Supabase...');
                
                const { data, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error fetching announcements:', error);
                    throw error;
                }

                console.log('Announcements fetched:', data);

                // Transform Supabase data to match the expected format
                if (data && data.length > 0) {
                    storedAnnouncements = data.map(announcement => ({
                        id: announcement.id,
                        type: announcement.type || 'general',
                        title: announcement.text || 'Announcement',
                        content: announcement.text || '',
                        date: announcement.created_at || new Date().toISOString(),
                        likes: announcement.likes || 0,
                        dislikes: announcement.dislikes || 0,
                        comments: announcement.comments || [],
                        featured: announcement.featured || false
                    }));
                } else {
                    // Use default announcements if database is empty
                    storedAnnouncements = getDefaultAnnouncements();
                }

                return storedAnnouncements;
            } catch (error) {
                console.error('Error loading announcements:', error);
                // Fallback to default announcements
                storedAnnouncements = getDefaultAnnouncements();
                return storedAnnouncements;
            }
        }

        // Default announcements as fallback
        function getDefaultAnnouncements() {
            return [
                {
                    id: 1,
                    type: 'promotion',
                    title: 'üéÑ Christmas Mega Sale - Up to 50% OFF!',
                    content: 'This Christmas season, enjoy massive discounts across our entire store! Get up to 50% OFF on Smart Watches, 40% OFF on Gaming PCs, 35% OFF on Kitchen Appliances including Kettles, Hotplates, and Rice Cookers. Plus, special bundle deals available! Visit us in-store or shop online. Sale ends December 31st. Limited stock available - first come, first served!',
                    date: new Date().toISOString(),
                    likes: 0,
                    dislikes: 0,
                    comments: [],
                    featured: true
                },
                {
                    id: 2,
                    type: 'new-stock',
                    title: 'üì¶ New Stock Alert: Latest Smart Watches Arrived!',
                    content: 'Exciting news! We just received a fresh shipment of the latest smart watches. Check out our updated collection with advanced fitness tracking, heart rate monitoring, and long battery life. Limited quantities available.',
                    date: new Date().toISOString(),
                    likes: 0,
                    dislikes: 0,
                    comments: []
                },
                {
                    id: 3,
                    type: 'price-change',
                    title: 'üìä Price Reduction: Gaming PCs Now More Affordable',
                    content: 'Great news for gamers! We have reduced prices on our Gaming PC lineup. Intel Core i7 Gaming PC now available at MWK 850,000 (down from MWK 950,000). Intel Core i5 Office PC now at MWK 550,000. These new prices are permanent!',
                    date: new Date().toISOString(),
                    likes: 0,
                    dislikes: 0,
                    comments: []
                }
            ];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function displayComments(comments) {
            if (!comments || comments.length === 0) {
                return '<p style="color: #9ca3af; text-align: center; font-style: italic;">No comments yet. Be the first to comment!</p>';
            }
            
            return comments.map(comment => `
                <div class="comment-item">
                    <div class="comment-author">${escapeHtml(comment.author)}</div>
                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                    <div class="comment-date">${formatDate(comment.date)}</div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function displayAnnouncements() {
            const container = document.getElementById('announcements-list');
            const loadingState = document.getElementById('loading-state');
            
            // Hide loading state
            if (loadingState) {
                loadingState.style.display = 'none';
            }
            
            if (!storedAnnouncements || storedAnnouncements.length === 0) {
                container.innerHTML = `
                    <div class="no-announcements">
                        <h2>üì¢ No Announcements Yet</h2>
                        <p>Check back soon for updates, promotions, and important news!</p>
                    </div>
                `;
                return;
            }

            const html = storedAnnouncements.map(announcement => `
                <div class="announcement-card ${announcement.featured ? 'featured-announcement' : ''}" data-id="${announcement.id}">
                    ${announcement.featured ? '<div class="featured-badge">‚≠ê FEATURED</div>' : ''}
                    <div class="announcement-header">
                        <span class="announcement-type type-${announcement.type}">${announcement.type.replace('-', ' ')}</span>
                        <span class="announcement-date">${formatDate(announcement.date)}</span>
                    </div>
                    <h2 class="announcement-title">${escapeHtml(announcement.title)}</h2>
                    <div class="announcement-content">${escapeHtml(announcement.content)}</div>
                    
                    <div class="announcement-actions">
                        <button class="action-btn like-btn" onclick="toggleLike(${announcement.id})">
                            üëç <span id="like-count-${announcement.id}">${announcement.likes || 0}</span>
                        </button>
                        <button class="action-btn dislike-btn" onclick="toggleDislike(${announcement.id})">
                            üëé <span id="dislike-count-${announcement.id}">${announcement.dislikes || 0}</span>
                        </button>
                        <button class="action-btn comment-btn" onclick="toggleComments(${announcement.id})">
                            üí¨ <span id="comment-count-${announcement.id}">${(announcement.comments || []).length}</span> Comments
                        </button>
                    </div>

                    <div class="comments-section" id="comments-${announcement.id}" style="display: none;">
                        <form class="comment-form" onsubmit="addComment(event, ${announcement.id})">
                            <textarea class="comment-input" placeholder="Share your thoughts..." required></textarea>
                            <button type="submit" class="submit-comment-btn">Post Comment</button>
                        </form>
                        <div id="comment-list-${announcement.id}">
                            ${displayComments(announcement.comments || [])}
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
            loadUserReactions();
        }

        // Update likes in Supabase
        async function updateAnnouncementInDB(announcementId, updates) {
            try {
                const { error } = await supabase
                    .from('announcements')
                    .update(updates)
                    .eq('id', announcementId);

                if (error) {
                    console.error('Error updating announcement:', error);
                }
            } catch (error) {
                console.error('Error updating announcement:', error);
            }
        }

        function toggleLike(announcementId) {
            const announcement = storedAnnouncements.find(a => a.id === announcementId);
            if (!announcement) return;

            const userReactions = JSON.parse(localStorage.getItem('userReactions')) || {};
            const key = `announcement-${announcementId}`;

            if (!announcement.likes) announcement.likes = 0;
            if (!announcement.dislikes) announcement.dislikes = 0;

            if (userReactions[key] === 'like') {
                announcement.likes--;
                delete userReactions[key];
            } else {
                if (userReactions[key] === 'dislike') {
                    announcement.dislikes--;
                }
                announcement.likes++;
                userReactions[key] = 'like';
            }

            localStorage.setItem('userReactions', JSON.stringify(userReactions));
            
            // Update in Supabase
            updateAnnouncementInDB(announcementId, {
                likes: announcement.likes,
                dislikes: announcement.dislikes
            });
            
            displayAnnouncements();
        }

        function toggleDislike(announcementId) {
            const announcement = storedAnnouncements.find(a => a.id === announcementId);
            if (!announcement) return;

            const userReactions = JSON.parse(localStorage.getItem('userReactions')) || {};
            const key = `announcement-${announcementId}`;

            if (!announcement.likes) announcement.likes = 0;
            if (!announcement.dislikes) announcement.dislikes = 0;

            if (userReactions[key] === 'dislike') {
                announcement.dislikes--;
                delete userReactions[key];
            } else {
                if (userReactions[key] === 'like') {
                    announcement.likes--;
                }
                announcement.dislikes++;
                userReactions[key] = 'dislike';
            }

            localStorage.setItem('userReactions', JSON.stringify(userReactions));
            
            // Update in Supabase
            updateAnnouncementInDB(announcementId, {
                likes: announcement.likes,
                dislikes: announcement.dislikes
            });
            
            displayAnnouncements();
        }

        function loadUserReactions() {
            const userReactions = JSON.parse(localStorage.getItem('userReactions')) || {};
            
            Object.keys(userReactions).forEach(key => {
                const announcementId = key.split('-')[1];
                const reaction = userReactions[key];
                const btn = document.querySelector(`[data-id="${announcementId}"] .${reaction}-btn`);
                if (btn) btn.classList.add('active');
            });
        }

        function toggleComments(announcementId) {
            const commentsSection = document.getElementById(`comments-${announcementId}`);
            if (commentsSection) {
                commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
            }
        }

        async function addComment(event, announcementId) {
            event.preventDefault();
            
            const textarea = event.target.querySelector('.comment-input');
            const commentText = textarea.value.trim();
            
            if (!commentText) return;

            const announcement = storedAnnouncements.find(a => a.id === announcementId);
            if (!announcement) return;

            const userName = prompt('Enter your name:') || 'Anonymous';
            
            if (!announcement.comments) announcement.comments = [];
            
            const newComment = {
                author: userName,
                text: commentText,
                date: new Date().toISOString().split('T')[0]
            };

            announcement.comments.push(newComment);

            // Update in Supabase
            await updateAnnouncementInDB(announcementId, {
                comments: announcement.comments
            });
            
            textarea.value = '';
            displayAnnouncements();
            
            // Re-open comments section
            setTimeout(() => {
                const commentsSection = document.getElementById(`comments-${announcementId}`);
                if (commentsSection) {
                    commentsSection.style.display = 'block';
                }
            }, 100);
        }

        // Subscription form handler
        document.getElementById('subscription-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('sub-name').value;
            const email = document.getElementById('sub-email').value;
            const whatsapp = document.getElementById('sub-whatsapp').value;

            if (!email && !whatsapp) {
                alert('Please provide at least an email address or WhatsApp number');
                return;
            }

            const subscription = {
                name: name,
                email: email,
                whatsapp: whatsapp,
                date: new Date().toISOString()
            };

            const subscriptions = JSON.parse(localStorage.getItem('subscriptions')) || [];
            subscriptions.push(subscription);
            localStorage.setItem('subscriptions', JSON.stringify(subscriptions));

            document.getElementById('sub-success').style.display = 'block';
            this.reset();

            setTimeout(() => {
                document.getElementById('sub-success').style.display = 'none';
            }, 5000);
        });

        // Update banner with latest announcement
        async function updateBanner() {
            if (storedAnnouncements && storedAnnouncements.length > 0) {
                const latest = storedAnnouncements[0];
                const banner = document.getElementById('announcement-banner');
                
                // Check if announcement has type for styling
                const icon = latest.type === 'positive' ? 'üéâ' : latest.type === 'negative' ? '‚ö†Ô∏è' : 'üì¢';
                banner.textContent = `${icon} ${latest.title}`;
                banner.style.display = 'block';
                
                // Add styling based on type
                if (latest.type === 'positive') {
                    banner.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                } else if (latest.type === 'negative') {
                    banner.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                }
            }
        }

        // Initialize page - Load from Supabase
        async function initializePage() {
            console.log('Initializing announcements page...');
            await loadAnnouncementsFromDB();
            displayAnnouncements();
            updateBanner();
        }

        // Run on page load
        initializePage();
    </script>
</body>
</html>