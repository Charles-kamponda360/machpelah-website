<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Machpelah Electronics - Quality Home Appliances</title>
    <link rel="stylesheet" href="css/style.css">
    
    <style>
            /* Location Welcome Banner */
            .location-banner {
                background: linear-gradient(135deg, #010006 0%, #020005 100%);
                color: white;
                padding: 1.5rem;
                text-align: center;
                margin-bottom: 2rem;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                animation: slideDown 0.5s ease-out;
                position: relative;
            }
            
            .location-banner.fade-out {
                animation: fadeOut 0.5s ease-out forwards;
            }
            
            .location-banner h3 {
                margin: 0 0 0.5rem 0;
                font-size: 1.5rem;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }
            
            .location-banner p {
                margin: 0;
                font-size: 1.1rem;
                line-height: 1.6;
            }
            
            .location-icon {
                display: inline-block;
                font-size: 1.8rem;
            }
            
            .delivery-badge {
                display: inline-block;
                background: #10b981;
                padding: 0.3rem 0.8rem;
                border-radius: 20px;
                font-weight: bold;
                margin-top: 0.5rem;
                font-size: 0.95rem;
            }
            
            .delivery-badge.low-cost {
                background: #f59e0b;
            }
            
            .close-banner-btn {
                position: absolute;
                top: 0.5rem;
                right: 0.5rem;
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.3s ease;
            }
            
            .close-banner-btn:hover {
                background: rgba(255, 255, 255, 0.3);
            }
            
            .countdown-timer {
                display: inline-block;
                background: rgba(255, 255, 255, 0.3);
                width: 28px;
                height: 28px;
                border-radius: 50%;
                line-height: 28px;
                font-weight: bold;
                font-size: 1rem;
                margin-left: 0.5rem;
                animation: pulse 1s ease-in-out infinite;
            }
            
            @keyframes pulse {
                0%, 100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.1);
                }
            }
            
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-20px);
                }
            }
            
            @media (max-width: 768px) {
                .location-banner {
                    padding: 1rem;
                    padding-right: 2.5rem;
                    margin-bottom: 1.5rem;
                }
                
                .location-banner h3 {
                    font-size: 1.2rem;
                }
                
                .location-banner p {
                    font-size: 0.95rem;
                }
                
                .close-banner-btn {
                    width: 25px;
                    height: 25px;
                    font-size: 1rem;
                }
                
                .countdown-timer {
                    width: 24px;
                    height: 24px;
                    line-height: 24px;
                    font-size: 0.9rem;
                }
            }
            
            /* Override CSS animations that hide products */
            .product-card {
                opacity: 1 !important;
                animation: none !important;
            }
            .filter-buttons {
                opacity: 1 !important;
                animation: none !important;
            }
            .footer {
                opacity: 1 !important;
                animation: none !important;
            }
            
            /* Keep category badge gold on hover */
            .product-card:hover .product-category {
                background: #FFD700 !important;
                color: #000 !important;
                transform: none !important;
            }
            
            /* Fixed Navigation Bar */
            .navbar {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 1000 !important;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
            }
            
            /* Add padding to body to prevent content from hiding under fixed navbar */
            body {
                padding-top: 70px !important;
            }
            
            /* Hamburger Menu Styles */
            .hamburger {
                display: none;
                flex-direction: column;
                gap: 4px;
                background: none;
                border: none;
                cursor: pointer;
                padding: 8px;
                z-index: 1001;
            }
            
            .hamburger span {
                width: 25px;
                height: 3px;
                background: #FFD700;
                border-radius: 3px;
                transition: all 0.3s ease;
            }
            
            .hamburger.active span:nth-child(1) {
                transform: rotate(45deg) translate(6px, 6px);
            }
            
            .hamburger.active span:nth-child(2) {
                opacity: 0;
            }
            
            .hamburger.active span:nth-child(3) {
                transform: rotate(-45deg) translate(6px, -6px);
            }
            
            /* Enhanced Mobile & Tablet Responsiveness */
            @media (max-width: 1024px) {
                /* Tablet styles */
                body {
                    font-size: 16px;
                    padding-top: 75px !important;
                }
                
                .hero h2 {
                    font-size: 2rem !important;
                }
                
                .hero p {
                    font-size: 1rem !important;
                }
                
                .products-grid {
                    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important;
                    gap: 1.25rem !important;
                }
                
                .product-name {
                    font-size: 1rem !important;
                }
                
                .product-price {
                    font-size: 1.3rem !important;
                }
            }
            
            @media (max-width: 768px) {
                /* Mobile styles */
                body {
                    font-size: 16px;
                    padding-top: 65px !important;
                }
                
                .container {
                    padding: 0 1rem !important;
                }
                
                .navbar {
                    padding: 0.75rem 0 !important;
                }
                
                .navbar .container {
                    flex-direction: row !important;
                    justify-content: space-between !important;
                    align-items: center !important;
                    padding: 0 1rem !important;
                }
                
                .nav-brand img {
                    height: 40px !important;
                }
                
                /* Show hamburger on mobile */
                .hamburger {
                    display: flex !important;
                }
                
                /* Hide menu by default on mobile */
                .nav-menu {
                    position: fixed !important;
                    top: 65px !important;
                    left: 0 !important;
                    right: 0 !important;
                    background: #111827 !important;
                    flex-direction: column !important;
                    width: 100% !important;
                    max-height: 0 !important;
                    overflow: hidden !important;
                    transition: max-height 0.3s ease !important;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
                    z-index: 999 !important;
                    padding: 0 !important;
                    display: flex !important;
                }
                
                .nav-menu.active {
                    max-height: 400px !important;
                    padding: 1rem 0 !important;
                }
                
                .nav-menu li {
                    width: 100% !important;
                    text-align: center !important;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
                    display: block !important;
                    list-style: none !important;
                }
                
                .nav-menu li:last-child {
                    border-bottom: none !important;
                }
                
                .nav-menu a {
                    display: block !important;
                    font-size: 1rem !important;
                    padding: 1rem 1.5rem !important;
                    width: 100% !important;
                    color: #ffffff !important;
                    text-decoration: none !important;
                }
                
                .nav-menu a:hover,
                .nav-menu a.active {
                    background: rgba(255, 215, 0, 0.1) !important;
                    color: #FFD700 !important;
                }
                
                .cart-badge {
                    font-size: 0.7rem !important;
                    padding: 0.15rem 0.4rem !important;
                }
                
                .hero {
                    padding: 2rem 0 !important;
                }
                
                .hero h2 {
                    font-size: 1.75rem !important;
                    margin-bottom: 0.75rem !important;
                }
                
                .hero p {
                    font-size: 0.95rem !important;
                }
                
                .products-section {
                    padding: 2rem 0 !important;
                }
                
                .products-section h2 {
                    font-size: 1.5rem !important;
                    margin-bottom: 1.5rem !important;
                }
                
                .filter-buttons {
                    gap: 0.5rem !important;
                    margin-bottom: 1.5rem !important;
                }
                
                .filter-btn {
                    padding: 0.6rem 1rem !important;
                    font-size: 0.85rem !important;
                }
                
                .products-grid {
                    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important;
                    gap: 1rem !important;
                }
                
                .product-card {
                    border-radius: 10px !important;
                }
                
                .product-image {
                    height: 180px !important;
                    padding: 0.75rem !important;
                    
                }
                
                .product-info {
                    padding: 1rem !important;
                }
                
                .product-category {
                    font-size: 0.65rem !important;
                    padding: 0.2rem 0.6rem !important;
                    margin-bottom: 0.4rem !important;
                }
                
                .product-name {
                    font-size: 0.9rem !important;
                    margin-bottom: 0.5rem !important;
                    line-height: 1.3 !important;
                }
                
                .product-price {
                    font-size: 1.1rem !important;
                    margin-bottom: 0.75rem !important;
                }
                
                .product-description {
                    font-size: 0.8rem !important;
                    margin-bottom: 0.75rem !important;
                    line-height: 1.4 !important;
                }
                
                .product-stock {
                    font-size: 0.8rem !important;
                    margin-bottom: 0.75rem !important;
                }
                
                .add-to-cart-btn {
                    padding: 0.7rem !important;
                    font-size: 0.85rem !important;
                    border-radius: 8px !important;
                }
                
                .footer {
                    padding: 2rem 0 1rem !important;
                    margin-top: 2rem !important;
                }
                
                .footer-content {
                    grid-template-columns: 1fr !important;
                    gap: 1.5rem !important;
                    text-align: center !important;
                }
                
                .footer-section h3 {
                    font-size: 1rem !important;
                }
                
                .footer-section p,
                .footer-section a {
                    font-size: 0.85rem !important;
                }
                
                .contact-item {
                    justify-content: center !important;
                }
                
                .footer-bottom {
                    font-size: 0.8rem !important;
                }
            }
            
            @media (max-width: 480px) {
                /* Small mobile styles */
                .hero h2 {
                    font-size: 1.4rem !important;
                }
                
                .hero p {
                    font-size: 0.9rem !important;
                }
                
                .products-section h2 {
                    font-size: 1.3rem !important;
                }
                
                .products-grid {
                    grid-template-columns: repeat(2, 1fr) !important;
                    gap: 0.75rem !important;
                }
                
                .product-image {
                    height: 160px !important;
                    padding: 0.75rem !important;
                }
                
                .product-info {
                    padding: 0.75rem !important;
                }
                
                .product-name {
                    font-size: 0.85rem !important;
                    min-height: auto !important;
                    line-height: 1.2 !important;
                }
                
                .product-price {
                    font-size: 1rem !important;
                    margin-bottom: 0.5rem !important;
                }
                
                .product-description {
                    display: none !important;
                }
                
                .product-stock {
                    font-size: 0.75rem !important;
                    margin-bottom: 0.5rem !important;
                }
                
                .add-to-cart-btn {
                    padding: 0.6rem !important;
                    font-size: 0.8rem !important;
                }
                
                .nav-menu a {
                    font-size: 0.95rem !important;
                    padding: 0.9rem 1.2rem !important;
                }
                
                .filter-btn {
                    padding: 0.5rem 0.85rem !important;
                    font-size: 0.8rem !important;
                }
            }
            
            /* Touch-friendly improvements */
            @media (hover: none) and (pointer: coarse) {
                /* For touchscreen devices */
                .nav-menu a,
                .filter-btn,
                .add-to-cart-btn {
                    min-height: 44px !important;
                    display: inline-flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                }
                
                .product-card:hover {
                    transform: none !important;
                }
            }
        </style>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <img src="images/icons/Machpelahtshirt.png" alt="Machpelah Electronics Logo" onerror="this.src='https://via.placeholder.com/50x50/FFD700/000000?text=ME'">
            </div>
            
            <!-- Hamburger Menu Button (Mobile Only) -->
            <button class="hamburger" id="hamburger" aria-label="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <ul class="nav-menu" id="nav-menu">
                <li><a href="index.html" class="active">Home</a></li>
                <li><a href="announcements.html">Announcements</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="cart.html" class="cart-link">
                    Cart <span id="cart-count" class="cart-badge">0</span>
                </a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="hero">
        <div class="container">
            <!-- Location Welcome Banner -->
            <div id="location-banner" style="display: none;"></div>
            
            <h2>Quality Electronics for Your Home</h2>
            <p>PCs, Smart Watches, Kettles, Hotplates, Rice Cookers & More</p>
        </div>
    </header>

    <!-- Products Section -->
    <main class="container">
        <section class="products-section">
            <h2>Our Products</h2>
            
            <!-- Loading State -->
            <div id="loading-state">
                <p style="font-size: 1.2rem; color: #667eea; text-align: center; padding: 2rem;">Loading products...</p>
            </div>

            <div class="filter-buttons" id="filter-buttons" style="display: none;">
                <!-- Filter buttons will be generated dynamically -->
            </div>
            
            <div id="products-grid" class="products-grid">
                <!-- Products will be loaded here dynamically -->
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Machpelah Electronics</h3>
                    <p>Your trusted source for quality home appliances</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="announcements.html">Announcements</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="admin/index.html">Admin</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <div class="contact-item">
                        <svg class="contact-icon" viewBox="0 0 20 20">
                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                        </svg>
                        <a href="mailto:machpelah@gmail.com">machpelah@gmail.com</a>
                    </div>
                    <div class="contact-item">
                        <svg class="contact-icon" viewBox="0 0 20 20">
                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                        </svg>
                        <a href="https://wa.me/265991765645" target="_blank">+265 991 765 645</a>
                    </div>
                </div>
            </div>
            <p class="footer-bottom">&copy; <span id="current-year"></span> Machpelah Electronics. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/cart.js"></script>
    <script src="js/products.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded');
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Hamburger menu toggle
            const hamburger = document.getElementById('hamburger');
            const navMenu = document.getElementById('nav-menu');
            
            hamburger.addEventListener('click', function() {
                this.classList.toggle('active');
                navMenu.classList.toggle('active');
            });
            
            // Close menu when clicking a link
            document.querySelectorAll('.nav-menu a').forEach(function(link) {
                link.addEventListener('click', function() {
                    hamburger.classList.remove('active');
                    navMenu.classList.remove('active');
                });
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!hamburger.contains(e.target) && !navMenu.contains(e.target)) {
                    hamburger.classList.remove('active');
                    navMenu.classList.remove('active');
                }
            });

            // Configuration
            const SUPABASE_URL = 'https://ycpaoqlcqziszlkbmtys.supabase.co';
            const SUPABASE_ANON_KEY = 'sb_publishable_pY3O8k5g8yki-zGXAMdlXQ_ugRNoL60';

            console.log('Initializing Supabase...');

            // Check if Supabase loaded
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase not loaded');
                document.getElementById('loading-state').innerHTML = '<p style="color: red; text-align: center;">Error: Could not load database connection</p>';
                return;
            }

            // Initialize Supabase
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase initialized');

            // Website View Counter
            async function trackPageView() {
                try {
                    console.log('Tracking page view...');
                    
                    // Get visitor information
                    const visitorInfo = {
                        page_url: window.location.href,
                        page_title: document.title,
                        referrer: document.referrer || 'Direct',
                        user_agent: navigator.userAgent,
                        screen_resolution: `${window.screen.width}x${window.screen.height}`,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Insert view record into database
                    const { data, error } = await supabase
                        .from('page_views')
                        .insert([visitorInfo]);
                    
                    if (error) {
                        console.error('Error tracking view:', error);
                    } else {
                        console.log('Page view tracked successfully');
                    }
                    
                    // Also update total views counter
                    await updateTotalViews();
                    
                } catch (error) {
                    console.error('Error in trackPageView:', error);
                }
            }

            // Update total views counter
            async function updateTotalViews() {
                try {
                    // Get current count
                    const { data, error } = await supabase
                        .from('site_stats')
                        .select('total_views')
                        .eq('id', 1)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                        console.error('Error fetching stats:', error);
                        return;
                    }
                    
                    // Update or insert
                    if (data) {
                        // Increment existing count
                        const { error: updateError } = await supabase
                            .from('site_stats')
                            .update({ 
                                total_views: data.total_views + 1,
                                last_updated: new Date().toISOString()
                            })
                            .eq('id', 1);
                        
                        if (updateError) {
                            console.error('Error updating stats:', updateError);
                        }
                    } else {
                        // Create initial record
                        const { error: insertError } = await supabase
                            .from('site_stats')
                            .insert([{ 
                                id: 1, 
                                total_views: 1,
                                last_updated: new Date().toISOString()
                            }]);
                        
                        if (insertError) {
                            console.error('Error creating stats:', insertError);
                        }
                    }
                } catch (error) {
                    console.error('Error in updateTotalViews:', error);
                }
            }

            // Track view when page loads (runs automatically in background)
            trackPageView();

            // Location Detection and Delivery Message
            async function detectLocationAndShowMessage() {
                try {
                    console.log('Detecting location...');
                    
                    // Try to get user's location using Geolocation API
                    if ('geolocation' in navigator) {
                        navigator.geolocation.getCurrentPosition(
                            async function(position) {
                                const lat = position.coords.latitude;
                                const lon = position.coords.longitude;
                                
                                console.log('Coordinates:', lat, lon);
                                
                                // Use reverse geocoding to get location name
                                await getLocationDetails(lat, lon);
                            },
                            async function(error) {
                                console.log('Geolocation error:', error.message);
                                // Fallback to IP-based location
                                await getLocationByIP();
                            },
                            {
                                enableHighAccuracy: false,
                                timeout: 10000,
                                maximumAge: 300000
                            }
                        );
                    } else {
                        // Browser doesn't support geolocation, use IP
                        await getLocationByIP();
                    }
                } catch (error) {
                    console.error('Error detecting location:', error);
                }
            }

            // Get location details from coordinates
            async function getLocationDetails(lat, lon) {
                try {
                    // Use OpenStreetMap Nominatim for reverse geocoding with higher zoom for specific areas
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=16&addressdetails=1`,
                        {
                            headers: {
                                'User-Agent': 'MachpelahElectronics/1.0'
                            }
                        }
                    );
                    
                    const data = await response.json();
                    console.log('Location data:', data);
                    
                    // Extract specific location information
                    const address = data.address || {};
                    
                    // Get most specific location available
                    const specificLocation = 
                        address.suburb || 
                        address.neighbourhood || 
                        address.village || 
                        address.hamlet || 
                        address.residential ||
                        address.quarter ||
                        '';
                    
                    const city = address.city || address.town || address.county || '';
                    const district = address.state || address.region || '';
                    const country = address.country || '';
                    
                    console.log('Detected location:', {
                        specific: specificLocation,
                        city: city,
                        district: district,
                        country: country
                    });
                    
                    // Determine location and show message
                    displayDeliveryMessage(specificLocation, city, district, country);
                    
                } catch (error) {
                    console.error('Error getting location details:', error);
                    // Fallback to IP-based location
                    await getLocationByIP();
                }
            }

            // Fallback: Get location by IP address
            async function getLocationByIP() {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    
                    console.log('IP Location data:', data);
                    
                    const city = data.city || '';
                    const region = data.region || '';
                    const country = data.country_name || '';
                    
                    displayDeliveryMessage('', city, region, country);
                    
                } catch (error) {
                    console.error('Error getting IP location:', error);
                    // Show generic message if all fails
                    displayDeliveryMessage('', '', '', 'Malawi');
                }
            }

            // Display personalized delivery message
            function displayDeliveryMessage(specificLocation, city, district, country) {
                const banner = document.getElementById('location-banner');
                
                // Normalize location names for comparison
                const locationLower = specificLocation.toLowerCase();
                const cityLower = city.toLowerCase();
                const districtLower = district.toLowerCase();
                const countryLower = country.toLowerCase();
                
                // Determine the best location name to display
                let displayLocation = specificLocation || city || district || 'your area';
                let deliveryMessage = '';
                let deliveryType = '';
                
                // Free delivery areas - check for specific suburbs/neighborhoods
                const freeDeliveryAreas = [
                    'chitawira', 'chitawira township',
                    'chichiri', 'chichiri shopping centre', 'chichiri mall',
                    'naperi', 'new naperi', 'naperi estate'
                ];
                
                const isFreeDelivery = freeDeliveryAreas.some(area => 
                    locationLower.includes(area) || cityLower.includes(area)
                );
                
                // Check if in other Blantyre areas
                const isBlantyre = 
                    cityLower.includes('blantyre') || 
                    districtLower.includes('blantyre') ||
                    locationLower.includes('blantyre');
                
                // Check if in Malawi
                const isMalawi = countryLower.includes('malawi');
                
                // Generate appropriate message
                if (isFreeDelivery) {
                    deliveryMessage = `ðŸ‘‹ Hello Dear Customer from <strong>${displayLocation}</strong>!<br>Do you know we can deliver to ${displayLocation}? <span class="delivery-badge">FREE DELIVERY</span> to your area!`;
                    deliveryType = 'free';
                } else if (isBlantyre) {
                    deliveryMessage = `ðŸ‘‹ Hello Dear Customer from <strong>${displayLocation}</strong>!<br>Do you know we can deliver to ${displayLocation}? We offer delivery at a <span class="delivery-badge low-cost">LOW COST</span>!`;
                    deliveryType = 'low-cost';
                } else if (isMalawi) {
                    deliveryMessage = `ðŸ‘‹ Hello Dear Customer from <strong>${displayLocation}</strong>!<br>Do you know we can deliver to ${displayLocation}? We offer delivery at a <span class="delivery-badge low-cost">LOW COST</span>!`;
                    deliveryType = 'low-cost';
                } else {
                    deliveryMessage = `ðŸ‘‹ Hello Dear Customer! Welcome to Machpelah Electronics.<br>We deliver across Malawi at competitive rates!`;
                    deliveryType = 'standard';
                }
                
                // Create banner with close button and countdown
                banner.innerHTML = `
                    <div class="location-banner" id="location-banner-content">
                        <button class="close-banner-btn" onclick="closeBanner()" aria-label="Close">Ã—</button>
                        <p>${deliveryMessage} <span class="countdown-timer" id="countdown">3</span></p>
                    </div>
                `;
                
                banner.style.display = 'block';
                
                // Start countdown timer
                let countdown = 3;
                const countdownElement = document.getElementById('countdown');
                
                const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdownElement) {
                        countdownElement.textContent = countdown;
                    }
                    
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        closeBanner();
                    }
                }, 1000); // Update every 1 second
                
                // Store interval ID so it can be cleared when manually closed
                window.bannerCountdownInterval = countdownInterval;
                
                // Log delivery info to database (optional)
                logDeliveryInfo(displayLocation, city, district, country, deliveryType);
            }

            // Close banner function
            window.closeBanner = function() {
                const banner = document.getElementById('location-banner');
                const bannerContent = document.getElementById('location-banner-content');
                
                // Clear countdown interval if it exists
                if (window.bannerCountdownInterval) {
                    clearInterval(window.bannerCountdownInterval);
                }
                
                if (bannerContent) {
                    bannerContent.classList.add('fade-out');
                    setTimeout(() => {
                        banner.style.display = 'none';
                    }, 500);
                }
            };

            // Log delivery information to database
            async function logDeliveryInfo(location, city, district, country, deliveryType) {
                try {
                    await supabase
                        .from('page_views')
                        .insert([{
                            page_url: window.location.href,
                            location_detected: `${location}, ${city}, ${district}, ${country}`,
                            delivery_type: deliveryType,
                            timestamp: new Date().toISOString()
                        }]);
                } catch (error) {
                    console.error('Error logging delivery info:', error);
                }
            }

            // Start location detection
            detectLocationAndShowMessage();

            // Optional: Track how long users stay on the page
            let startTime = Date.now();

            window.addEventListener('beforeunload', async function() {
                const timeSpent = Math.round((Date.now() - startTime) / 1000); // in seconds
                
                // Log time spent (optional)
                try {
                    await supabase
                        .from('page_views')
                        .insert([{
                            page_url: window.location.href,
                            time_spent_seconds: timeSpent,
                            timestamp: new Date().toISOString()
                        }]);
                } catch (error) {
                    console.error('Error logging time spent:', error);
                }
            });

            let allProducts = [];
            window.allProducts = allProducts;

            // Load products
            async function loadProducts() {
                try {
                    console.log('Fetching products...');
                    
                    const { data, error } = await supabase
                        .from('products')
                        .select('*')
                        .order('id', { ascending: false });
                    
                    if (error) {
                        console.error('Database error:', error);
                        throw error;
                    }
                    
                    console.log('Products fetched:', data.length);
                    allProducts = data || [];
                    window.allProducts = allProducts;
                    
                    // Make products globally accessible for cart
                    if (!window.productsData) {
                        window.productsData = {};
                    }
                    allProducts.forEach(function(p) {
                        window.productsData[p.id] = p;
                    });
                    console.log('Products stored globally:', Object.keys(window.productsData).length);
                    
                    // Log stock info
                    console.log('Product stock check:');
                    allProducts.forEach(function(p) {
                        console.log(`- ${p.name}: Stock = ${p.stock}, ID = ${p.id}`);
                    });
                    
                    // Hide loading
                    document.getElementById('loading-state').style.display = 'none';
                    
                    if (allProducts.length === 0) {
                        document.getElementById('products-grid').innerHTML = '<p style="text-align: center; padding: 2rem;">No products available</p>';
                        return;
                    }
                    
                    displayProducts(allProducts);
                    updateFilterButtons();
                    
                } catch (error) {
                    console.error('Error loading products:', error);
                    document.getElementById('loading-state').innerHTML = '<p style="color: red; text-align: center;">Error loading products. Please refresh.</p>';
                }
            }

            // Display products
            function displayProducts(products) {
                const grid = document.getElementById('products-grid');
                console.log('Displaying', products.length, 'products');
                
                grid.innerHTML = products.map(function(p) {
                    return `
                        <div class="product-card">
                            <img src="${p.image}" alt="${p.name}" class="product-image" onerror="this.src='https://via.placeholder.com/300x300/f5f5f5/666?text=Product'">
                            <div class="product-info">
                                <span class="product-category">${p.category || 'General'}</span>
                                <h3 class="product-name">${p.name}</h3>
                                <p class="product-price">MWK ${p.price.toLocaleString()}</p>
                                ${p.description ? `<p class="product-description">${p.description}</p>` : ''}
                                <p class="product-stock ${p.stock > 0 ? 'in-stock' : 'out-of-stock'}">
                                    ${p.stock > 0 ? p.stock + ' in stock' : 'Out of stock'}
                                </p>
                                <button class="add-to-cart-btn" data-id="${p.id}" ${p.stock === 0 ? 'disabled' : ''}>
                                    ${p.stock > 0 ? 'Add to Cart' : 'Out of Stock'}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('Products rendered');
                
                // Add click handlers
                document.querySelectorAll('.add-to-cart-btn').forEach(function(btn) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        const id = parseInt(this.dataset.id);
                        const product = allProducts.find(function(p) { return p.id === id; });
                        
                        console.log('Button clicked - Product ID:', id);
                        console.log('Product found:', product);
                        console.log('Product stock:', product ? product.stock : 'N/A');
                        
                        if (!product) {
                            console.error('Product not found in allProducts array');
                            alert('Error: Product not found');
                            return;
                        }
                        
                        if (product.stock <= 0) {
                            alert('This product is out of stock');
                            return;
                        }
                        
                        // Check if cart is available
                        if (typeof cart === 'undefined') {
                            console.error('Cart not initialized');
                            alert('Cart system not ready. Please refresh the page.');
                            return;
                        }
                        
                        // Add to cart
                        try {
                            // Pass the complete product object
                            cart.addItem(id, product);
                            
                            // Also store in a backup location
                            const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
                            const existingIndex = cartItems.findIndex(function(item) { return item.id === id; });
                            
                            if (existingIndex >= 0) {
                                cartItems[existingIndex].quantity += 1;
                            } else {
                                cartItems.push({
                                    id: product.id,
                                    name: product.name,
                                    price: product.price,
                                    image: product.image,
                                    category: product.category,
                                    description: product.description,
                                    stock: product.stock,
                                    quantity: 1
                                });
                            }
                            
                            localStorage.setItem('cart', JSON.stringify(cartItems));
                            console.log('Product added to cart successfully');
                            console.log('Cart items:', cartItems);
                            
                            // Visual feedback
                            const originalText = this.textContent;
                            const originalBg = this.style.background;
                            
                            this.textContent = 'âœ“ Added!';
                            this.style.background = '#10b981';
                            
                            setTimeout(() => {
                                this.textContent = originalText;
                                this.style.background = originalBg;
                            }, 1500);
                        } catch (error) {
                            console.error('Error adding to cart:', error);
                            alert('Error adding product to cart');
                        }
                    });
                });
            }

            // Filter buttons
            function updateFilterButtons() {
                const categories = ['all'].concat([...new Set(allProducts.map(p => p.category))].sort());
                const container = document.getElementById('filter-buttons');
                
                container.innerHTML = categories.map((cat, i) => 
                    `<button class="filter-btn ${i === 0 ? 'active' : ''}" data-cat="${cat}">
                        ${cat === 'all' ? 'All Products' : cat + 's'}
                    </button>`
                ).join('');
                
                container.style.display = 'flex';
                
                // Add filter click handlers
                document.querySelectorAll('.filter-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        const cat = this.dataset.cat;
                        const filtered = cat === 'all' ? allProducts : allProducts.filter(p => p.category === cat);
                        displayProducts(filtered);
                    });
                });
            }

            // Start loading
            loadProducts();
        });
    </script>
</body>
</html>